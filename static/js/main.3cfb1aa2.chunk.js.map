{"version":3,"sources":["../../display/dist/constants/index.js","../../display/dist/utils/index.js","../../display/dist/pitch-display/index.js","components/button/index.js","constants/colors.js","model.ts","components/pitch/index.tsx","components/pitch/pitch-monitor.tsx","components/main/app-frame.tsx","components/error-modal/index.js","components/main/about.tsx","App.tsx","reportWebVitals.ts","index.tsx","services/s1Encoding.js"],"names":["NOTE_STRINGS","centsOffFromPitch","frequency","note","Math","floor","log","pow","frequencyFromNoteNumber","PitchDisplay","container","timeSpan","this","frequencies","melodyNotes","introStateListeners","background","highlight","style","position","canvasStyle","bgCanvas","document","createElement","setAttribute","bgContext","getContext","melodyCanvas","melodyContext","noteCanvas","noteContext","appendChild","lastSongPos","speedChanged","undefined","playingSpeed","melodyStart","inIntro","resize","callback","push","i","length","splice","w","clientWidth","h","clientHeight","dpr","window","devicePixelRatio","scaledW","scaledH","width","height","scale","scaleX","scaleLinear","domain","range","margin","scaleY","render","time","songPos","calculateSongPos","start","prevNote","duration","end","Infinity","nextNote","melodyPitch","f","noteNum","round","noteFromPitch","pitch","nearestMelodyNote","getNearestMelodyNote","diff","Object","assign","filter","val","now","changePlayingSpeed","speed","Date","getTime","full","cleanupFrequencies","drawBackground","drawMelody","drawNotes","checkIntroState","nowInIntro","color","fillStyle","clearRect","fillRect","y","font","fillText","beginPath","strokeStyle","notes","t","c","clarity","x","stroke","moveTo","lineTo","arc","PI","fill","ctx","lineWidth","lineCap","startX","endX","ControlButton","colorPressed","className","Icon","onCancel","onPress","onRelease","size","useState","pressed","setPressed","handlePress","handleRelease","handleCancel","onMouseDown","onMouseUp","onMouseLeave","onTouchStart","onTouchEnd","onTouchCancel","ForwardButton","props","SkipBackwardCircleFill","PauseButton","PauseCircleFill","StopButton","StopCircleFill","SkipStartButton","SkipEndCircleFill","SkipStartCircleFill","BACKGROUND","store","createStore","windowSize","detectorName","clarityThreshold","enabled","loading","loaded","stream","audioOptions","audio","echoCancellation","autoGainControl","workerConnection","melody","error","setWindowSize","action","state","payload","setDetectorName","setClarityThreshold","setEnabled","setStream","setLoading","setLoaded","setWorkerConnection","setError","checkAudioContextSupport","thunk","actions","getState","AudioContext","webkitAudioContext","console","initializeStream","a","options","navigator","mediaDevices","getUserMedia","stopStream","getTracks","stop","initializeWorker","worker","Worker","process","messenger","WorkerMessenger","ParentHandshake","connection","setMelodyNotes","typedHooks","createTypedHooks","useStoreActions","useStoreState","useStoreDispatch","PitchComponent","freq","pitchDisplay","useRef","setInIntro","updatePitch","useCallback","current","pushFrequency","requestAnimationFrame","requestRef","useEffect","animate","cancelAnimationFrame","useAnimationFrame","onResize","addEventListener","removeEventListener","hasNotes","btnColor","btnColorPressed","onDisplayRef","element","setBackgroundColor","playSong","subscribeToIntroState","onStop","skipIntroPopover","Popover","id","Title","as","Content","Fragment","ref","Navbar","fixed","bg","OverlayTrigger","show","placement","overlay","seekToFirstNote","pauseSong","fastForwardSong","convertByteToFloatBuffer","byteBuf","floatBuf","PitchMonitor","powerThreshold","pitchRenderer","React","setFreq","setClarity","pendingRef","pitchSetupRef","setupConnection","remoteHandle","call","pitchSetup","buffer","Float32Array","audioContext","mediaStreamSource","createMediaStreamSource","analyser","createAnalyser","getFloatTimeDomainData","byteBuffer","Uint8Array","fftSize","connect","warn","getByteTimeDomainData","sampleRate","result","escape","cancelRender","renderFrame","PitchRenderer","AppFrame","children","params","qs","parse","location","search","substr","s1","decodeS1","alert","toString","readMelodyNotes","ErrorModal","onClose","txt","Modal","onHide","backdrop","keyboard","Header","closeButton","Body","Footer","Button","variant","onClick","StartButton","active","setActive","handle","setTimeout","clearTimeout","disabled","ExternalLink","link","target","href","rel","SongInfo","lyrics","music","title","newTitle","replace","property","content","AboutSection","open","setOpen","iconProps","caret","Collapse","in","About","App","mainDisplay","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","StrictMode","getElementById","PRECISION","SHORT_BITS","LONG_BITS","data","base64","unsafeBase64","Buffer","from","Error","pos","checksum","origChecksum","readUInt16BE","days","created","lastEnd","bytes","readUIntBE","value"],"mappings":"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","file":"static/js/main.3cfb1aa2.chunk.js","sourcesContent":["// Notes start normally from C but we start from F note by using offset.\nexport const NOTE_OFFSET = 7;\nexport const NOTE_STRINGS = [\n    'F',\n    'F♯',\n    'G',\n    'G♯',\n    'A',\n    'A♯',\n    'B',\n    'C',\n    'C♯',\n    'D',\n    'D♯',\n    'E',\n];\nexport const OCTAVE_COLORS = [\n    [121, 85, 72],\n    [158, 158, 158],\n    [96, 125, 139],\n    [76, 175, 80],\n    [244, 67, 54],\n    [33, 150, 243],\n    [0, 150, 136],\n    [255, 235, 59],\n    [0, 188, 212],\n];\n","import { OCTAVE_COLORS } from '../constants';\nexport function noteFromPitch(frequency) {\n    let noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));\n    return Math.round(noteNum) + 69;\n}\nexport function frequencyFromNoteNumber(note) {\n    return 440 * Math.pow(2, (note - 69) / 12);\n}\nexport function centsOffFromPitch(frequency, note) {\n    return Math.floor((1200 * Math.log(frequency / frequencyFromNoteNumber(note))) / Math.log(2));\n}\nexport function colorFromNote(note) {\n    let octave = Math.floor(note / 12) - 1;\n    let idx = Math.min(octave, OCTAVE_COLORS.length - 1);\n    idx = Math.max(0, idx);\n    return OCTAVE_COLORS[idx];\n}\n","import { scaleLinear } from 'd3-scale';\nimport { NOTE_OFFSET, NOTE_STRINGS } from '../constants';\nimport { noteFromPitch, centsOffFromPitch } from '../utils';\nclass PitchDisplay {\n    constructor(container, timeSpan = 15000) {\n        this.frequencies = [];\n        this.melodyNotes = [];\n        this.introStateListeners = [];\n        this.background = '#efefef';\n        this.highlight = '#888888';\n        this.container = container;\n        this.container.style.position = 'relative';\n        const canvasStyle = 'position: absolute; width: 100%; height: 100%;';\n        this.bgCanvas = document.createElement('canvas');\n        this.bgCanvas.setAttribute('style', canvasStyle);\n        this.bgContext = this.bgCanvas.getContext('2d');\n        this.melodyCanvas = document.createElement('canvas');\n        this.melodyCanvas.setAttribute('style', canvasStyle);\n        this.melodyContext = this.melodyCanvas.getContext('2d');\n        this.noteCanvas = document.createElement('canvas');\n        this.noteCanvas.setAttribute('style', canvasStyle);\n        this.noteContext = this.noteCanvas.getContext('2d');\n        this.container.appendChild(this.bgCanvas);\n        this.container.appendChild(this.melodyCanvas);\n        this.container.appendChild(this.noteCanvas);\n        this.timeSpan = timeSpan;\n        this.lastSongPos = 0;\n        this.speedChanged = undefined;\n        this.playingSpeed = 0;\n        this.melodyStart = 0;\n        this.inIntro = false;\n        this.resize();\n    }\n    subscribeToIntroState(callback) {\n        this.introStateListeners.push(callback);\n        return () => {\n            // unsubscribe function\n            for (let i = 0; i < this.introStateListeners.length; i++) {\n                if (this.introStateListeners[i] === callback) {\n                    this.introStateListeners.splice(i, 1);\n                    return;\n                }\n            }\n        };\n    }\n    resize() {\n        let w = this.container.clientWidth;\n        let h = this.container.clientHeight;\n        // If device pixel ratio > 1 like in Retina display, canvas content\n        // looks blurry if not scaled\n        const dpr = window.devicePixelRatio;\n        const scaledW = Math.floor(dpr * w);\n        const scaledH = Math.floor(dpr * h);\n        this.bgCanvas.width = scaledW;\n        this.bgCanvas.height = scaledH;\n        this.bgContext.scale(dpr, dpr);\n        this.melodyCanvas.width = scaledW;\n        this.melodyCanvas.height = scaledH;\n        this.melodyContext.scale(dpr, dpr);\n        this.noteCanvas.width = scaledW;\n        this.noteCanvas.height = scaledH;\n        this.noteContext.scale(dpr, dpr);\n        this.scaleX = scaleLinear()\n            .domain([-(this.timeSpan / 2), this.timeSpan / 2])\n            .range([0, w]);\n        let margin = h / (NOTE_STRINGS.length + 4);\n        this.scaleY = scaleLinear()\n            .domain([0, 2 * NOTE_STRINGS.length - 1])\n            .range([h - margin, margin]);\n        this.render();\n    }\n    // Returns nearest melody note by given time.\n    getNearestMelodyNote(time) {\n        if (!this.melodyNotes.length) {\n            return undefined;\n        }\n        const songPos = this.calculateSongPos(time);\n        for (let i = 0; i < this.melodyNotes.length; i++) {\n            const note = this.melodyNotes[i];\n            let start = 0;\n            if (i > 0) {\n                const prevNote = this.melodyNotes[i - 1];\n                // calculate time between two notes\n                start = (prevNote.start + prevNote.duration + note.start) / 2;\n            }\n            let end = Infinity;\n            if (i < this.melodyNotes.length - 1) {\n                // calculate time between two notes\n                const nextNote = this.melodyNotes[i + 1];\n                end = (note.start + note.duration + nextNote.start) / 2;\n            }\n            if (songPos >= start && songPos < end) {\n                return note;\n            }\n        }\n        // no note found\n        return undefined;\n    }\n    pushFrequency(frequency) {\n        // calculate pitch of the frequency\n        const f = frequency.frequency;\n        const note = noteFromPitch(f);\n        const centsOff = centsOffFromPitch(f, note);\n        const pitch = note + centsOff / 100;\n        let melodyPitch;\n        const nearestMelodyNote = this.getNearestMelodyNote(frequency.time);\n        if (nearestMelodyNote) {\n            // check if other octaves of this pitch are closer to the melody note\n            let diff = (pitch - nearestMelodyNote.pitch) % 12;\n            if (diff > 6) {\n                diff -= 12;\n            }\n            else if (diff < -6) {\n                diff += 12;\n            }\n            melodyPitch = nearestMelodyNote.pitch + diff;\n        }\n        this.frequencies.push(Object.assign(Object.assign({}, frequency), { pitch,\n            melodyPitch }));\n    }\n    cleanupFrequencies() {\n        // Throw away the frequencies that are out of the current display window\n        this.frequencies = this.frequencies.filter((val) => this.now - val.time < this.timeSpan / 2);\n    }\n    setMelodyNotes(melodyNotes) {\n        this.melodyNotes = melodyNotes;\n        this.melodyStart = melodyNotes.length ? melodyNotes[0].start : 0;\n    }\n    playSong() {\n        this.changePlayingSpeed(1);\n    }\n    fastForwardSong() {\n        this.changePlayingSpeed(3);\n    }\n    pauseSong() {\n        this.changePlayingSpeed(0);\n    }\n    calculateSongPos(now) {\n        return this.lastSongPos + this.playingSpeed * (now - this.speedChanged);\n    }\n    changePlayingSpeed(speed) {\n        const now = new Date().getTime();\n        if (this.speedChanged === undefined) {\n            this.speedChanged = now;\n        }\n        this.lastSongPos = this.calculateSongPos(now);\n        this.playingSpeed = speed;\n        this.speedChanged = now;\n    }\n    seekToFirstNote() {\n        this.changePlayingSpeed(0);\n        this.lastSongPos = this.melodyStart;\n    }\n    render(full = true) {\n        this.now = new Date().getTime();\n        // calculate song position\n        const songPos = this.calculateSongPos(this.now);\n        this.cleanupFrequencies();\n        if (full) {\n            this.drawBackground();\n        }\n        this.drawMelody(songPos);\n        this.drawNotes();\n        this.checkIntroState(songPos);\n    }\n    checkIntroState(songPos) {\n        const nowInIntro = songPos < this.melodyStart;\n        if (nowInIntro !== this.inIntro) {\n            this.inIntro = nowInIntro;\n            for (let i = 0; i < this.introStateListeners.length; i++) {\n                this.introStateListeners[i](nowInIntro);\n            }\n        }\n    }\n    setBackgroundColor(color) {\n        this.background = color;\n        this.drawBackground();\n    }\n    setHighlightColor(color) {\n        this.highlight = color;\n        this.drawBackground();\n    }\n    drawBackground() {\n        let w = this.container.clientWidth;\n        let h = this.container.clientHeight;\n        this.bgContext.fillStyle = this.background;\n        this.bgContext.clearRect(0, 0, w, h);\n        this.bgContext.fillRect(0, 0, w, h);\n        for (let i = 0; i < 2 * NOTE_STRINGS.length; ++i) {\n            let y = this.scaleY(i);\n            this.bgContext.fillStyle = this.highlight + '55';\n            this.bgContext.fillRect(0, y, w, 1);\n            this.bgContext.fillStyle = this.highlight;\n            this.bgContext.font = '14px Fira Sans';\n            this.bgContext.fillText(NOTE_STRINGS[i % NOTE_STRINGS.length], this.scaleX(0) + 20, y - 2);\n        }\n        this.bgContext.fillStyle = this.highlight + '55';\n        this.bgContext.fillRect(this.scaleX(0), 0, 1, h);\n    }\n    drawNotes() {\n        let w = this.container.clientWidth;\n        let h = this.container.clientHeight;\n        this.noteContext.clearRect(0, 0, w, h);\n        this.noteContext.beginPath();\n        this.noteContext.strokeStyle = 'rgba(0, 0, 0, 0.1)';\n        // Calculate notes and colors from frequencies\n        const notes = [];\n        for (let frequency of this.frequencies) {\n            let t = frequency.time;\n            let c = frequency.clarity;\n            let x = this.scaleX(t - this.now);\n            const pitch = frequency.melodyPitch\n                ? frequency.melodyPitch\n                : frequency.pitch;\n            let y = this.scaleY((pitch + NOTE_OFFSET) % 24);\n            // let color = colorFromNote(Math.floor(frequency.pitch));\n            const color = [254, 74, 73];\n            notes.push({\n                time: t,\n                x,\n                y,\n                clarity: c,\n                color,\n            });\n        }\n        // Draw lines\n        const timeCutoff = 500;\n        this.noteContext.beginPath();\n        for (let i = 1; i < notes.length; ++i) {\n            const { x, y, time } = notes[i];\n            const prevTime = notes[i - 1].time;\n            if (time - prevTime > timeCutoff) {\n                this.noteContext.stroke();\n                this.noteContext.beginPath();\n                this.noteContext.moveTo(x, y);\n            }\n            else {\n                this.noteContext.lineTo(x, y);\n            }\n        }\n        this.noteContext.stroke();\n        // Draw circles\n        for (let note of notes) {\n            const { x, y, clarity, color } = note;\n            this.noteContext.fillStyle = `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${clarity * 0.5})`;\n            this.noteContext.beginPath();\n            this.noteContext.arc(x, y, 5, 0, Math.PI * 2);\n            this.noteContext.fill();\n        }\n    }\n    drawMelody(songPos) {\n        let w = this.container.clientWidth;\n        let h = this.container.clientHeight;\n        const ctx = this.melodyContext;\n        ctx.clearRect(0, 0, w, h);\n        ctx.strokeStyle = 'rgba(32, 164, 243, 0.8)';\n        ctx.lineWidth = h / 36;\n        ctx.lineCap = 'round';\n        for (let note of this.melodyNotes) {\n            const { start, duration, pitch } = note;\n            const startX = this.scaleX(start - songPos);\n            const endX = this.scaleX(start - songPos + duration);\n            const y = this.scaleY((pitch + NOTE_OFFSET) % 24);\n            ctx.beginPath();\n            // because lineCap is round, make line a bit shorter\n            ctx.moveTo(startX + ctx.lineWidth / 2, y);\n            ctx.lineTo(endX - ctx.lineWidth / 2, y);\n            ctx.stroke();\n        }\n    }\n}\nexport { PitchDisplay };\n","import React, { useState } from 'react';\nimport {\n  PauseCircleFill,\n  SkipBackwardCircleFill,\n  SkipEndCircleFill,\n  SkipStartCircleFill,\n  StopCircleFill,\n} from 'react-bootstrap-icons';\n\nimport './button.css';\n\nfunction ControlButton({\n  color,\n  colorPressed,\n  className,\n  Icon,\n  onCancel,\n  onPress,\n  onRelease,\n  size,\n}) {\n  const [pressed, setPressed] = useState(false);\n  const handlePress = () => {\n    setPressed(true);\n    if (onPress) {\n      onPress();\n    }\n  };\n  const handleRelease = () => {\n    setPressed(false);\n    if (onRelease) {\n      onRelease();\n    }\n  };\n  const handleCancel = () => {\n    setPressed(false);\n    if (onCancel) {\n      onCancel();\n    }\n  };\n  return (\n    <div\n      className={`ctrl-btn ${pressed ? 'ctrl-btn-pressed' : ''} ${className}`}\n      onMouseDown={handlePress}\n      onMouseUp={handleRelease}\n      onMouseLeave={handleCancel}\n      onTouchStart={handlePress}\n      onTouchEnd={handleRelease}\n      onTouchCancel={handleCancel}\n    >\n      <Icon color={pressed ? colorPressed : color} size={size} />\n    </div>\n  );\n}\n\nexport const ForwardButton = (props) => (\n  <ControlButton Icon={SkipBackwardCircleFill} {...props} />\n);\n\nexport const PauseButton = (props) => (\n  <ControlButton Icon={PauseCircleFill} {...props} />\n);\n\nexport const StopButton = (props) => (\n  <ControlButton Icon={StopCircleFill} {...props} />\n);\n\nexport const SkipStartButton = (props) => (\n  <ControlButton\n    Icon={props.inIntro ? SkipEndCircleFill : SkipStartCircleFill}\n    {...props}\n  />\n);\n","export const BACKGROUND = '#e8eaec';\n\nexport const PRIMARY = '#3f51b5';\nexport const PRIMARY_LIGHT = '#757de8';\nexport const PRIMARY_DARK = '#002984';\nexport const PRIMARY_TEXT = '#ffffff';\n\nexport const SECONDARY = '#9c27b0';\nexport const SECONDARY_LIGHT = '#d05ce3';\nexport const SECONDARY_DARK = '#6a0080';\nexport const SECONDARY_TEXT = '#ffffff';\n","import {\n  action,\n  Action,\n  createStore,\n  createTypedHooks,\n  thunk,\n  Thunk,\n} from 'easy-peasy';\nimport { Connection, ParentHandshake, WorkerMessenger } from 'post-me';\n\ntype Detector = 'mcleod' | 'autocorrelation';\n\ntype ErrorType = 'audio-context' | 'mic-stream' | 'worker';\n\ninterface IMelodyNote {\n  start: number;\n  duration: number;\n  pitch: number;\n}\n\ntype IMelodyNotes = IMelodyNote[];\n\ninterface Melody {\n  title: string;\n  notes: IMelodyNotes;\n}\n\ninterface StoreModel {\n  windowSize: number;\n  setWindowSize: Action<StoreModel, number>;\n\n  detectorName: Detector;\n  setDetectorName: Action<StoreModel, Detector>;\n\n  clarityThreshold: number;\n  setClarityThreshold: Action<StoreModel, number>;\n\n  enabled: boolean;\n  setEnabled: Action<StoreModel, boolean>;\n\n  stream: MediaStream | null | undefined;\n  audioOptions: MediaStreamConstraints;\n  setStream: Action<StoreModel, MediaStream | null>;\n  loading: boolean;\n  setLoading: Action<StoreModel, boolean>;\n  loaded: boolean;\n  setLoaded: Action<StoreModel, boolean>;\n  initializeStream: Thunk<StoreModel, void>;\n  stopStream: Thunk<StoreModel, void>;\n\n  workerConnection: Connection | null | undefined;\n  setWorkerConnection: Action<StoreModel, Connection | null>;\n  initializeWorker: Thunk<StoreModel, void>;\n\n  melody: Melody;\n  setMelodyNotes: Action<StoreModel, IMelodyNotes>;\n  error: ErrorType;\n}\n\nexport const store = createStore<StoreModel>({\n  // Default values\n  windowSize: 2048, // 1024\n  detectorName: 'mcleod',\n  clarityThreshold: 0.7, // 0.5\n  enabled: false,\n  loading: false,\n  loaded: false,\n  stream: null,\n  audioOptions: { audio: { echoCancellation: true, autoGainControl: true } },\n  workerConnection: null,\n  melody: {},\n  error: null,\n\n  setWindowSize: action((state, payload) => {\n    state.windowSize = payload;\n  }),\n  setDetectorName: action((state, payload) => {\n    state.detectorName = payload;\n  }),\n  setClarityThreshold: action((state, payload) => {\n    state.clarityThreshold = payload;\n  }),\n  setEnabled: action((state, payload) => {\n    state.enabled = payload;\n  }),\n  setStream: action((state, payload) => {\n    state.stream = payload;\n  }),\n  setLoading: action((state, payload) => {\n    state.loading = payload;\n  }),\n  setLoaded: action((state, payload) => {\n    state.loaded = payload;\n  }),\n  setWorkerConnection: action((state, payload) => {\n    state.workerConnection = payload;\n  }),\n  setError: action((state, payload) => {\n    state.error = payload;\n  }),\n  checkAudioContextSupport: thunk((actions, payload, { getState }) => {\n    // Safari and old versions of Chrome use window.webkitAudioContext\n    const AudioContext = window.AudioContext || window.webkitAudioContext;\n    if (AudioContext === undefined) {\n      // browser does not support Audio Context\n      actions.setError('audio-context');\n      console.error('Browser does not have window.AudioContext support');\n    }\n  }),\n  initializeStream: thunk(async (actions, payload, { getState }) => {\n    const state = getState();\n    const options = state.audioOptions;\n\n    actions.setLoading(true);\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia(options);\n      actions.setStream(stream);\n      actions.setLoading(false);\n      actions.setLoaded(true);\n    } catch (e) {\n      actions.setError('mic-stream');\n      console.error(e);\n      actions.setStream(null);\n      actions.setLoading(false);\n      actions.setLoaded(false);\n    }\n  }),\n  stopStream: thunk(async (actions, payload, { getState }) => {\n    const stream = getState().stream;\n\n    if (stream) {\n      for (const track of stream.getTracks()) {\n        track.stop();\n      }\n    }\n\n    actions.setStream(null);\n    actions.setLoading(false);\n    actions.setLoaded(false);\n  }),\n  initializeWorker: thunk(async (actions) => {\n    const worker = new Worker(\n      `${process.env.PUBLIC_URL}/pitch-detection/worker.js`\n    );\n\n    const messenger = new WorkerMessenger({ worker });\n\n    try {\n      const connection = await ParentHandshake(messenger, {}, 5, 1000);\n      actions.setWorkerConnection(connection);\n    } catch (e) {\n      actions.setError('worker');\n      console.error('Failed to connect to worker', e);\n      actions.setWorkerConnection(null);\n    }\n  }),\n\n  setMelodyNotes: action((state, payload) => {\n    state.melody.notes = payload;\n  }),\n});\n\n// Create a version of the standard hooks that always references our `StoreModel` type\nconst typedHooks = createTypedHooks<StoreModel>();\n\nexport const useStoreActions = typedHooks.useStoreActions;\nexport const useStoreDispatch = typedHooks.useStoreDispatch;\nexport const useStoreState = typedHooks.useStoreState;\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { Navbar, Popover, OverlayTrigger } from 'react-bootstrap';\n\nimport { PitchDisplay } from 'pitch-display';\n\nimport {\n  ForwardButton,\n  PauseButton,\n  SkipStartButton,\n  StopButton,\n} from '../button';\nimport { BACKGROUND } from '../../constants/colors';\nimport { useStoreActions, useStoreState } from '../../model';\n\n// Custom React hook for requestAnimationFrame\nconst useAnimationFrame = (callback) => {\n  const requestRef = useRef();\n\n  useEffect(() => {\n    const animate = (time) => {\n      callback(time);\n      requestRef.current = requestAnimationFrame(animate);\n    };\n\n    requestRef.current = requestAnimationFrame(animate);\n\n    return () => {\n      cancelAnimationFrame(requestRef.current);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []); // run this effect only once\n};\n\nexport interface PitchProps {\n  freq: number | null;\n  clarity: number | null;\n}\n\nfunction PitchComponent({ freq, clarity }: PitchProps) {\n  const pitchDisplay = useRef();\n  const [inIntro, setInIntro] = useState(false);\n\n  const updatePitch = useCallback(() => {\n    if (!pitchDisplay.current) {\n      return;\n    }\n\n    if (freq && freq > 0) {\n      const time = new Date().getTime();\n      pitchDisplay.current.pushFrequency({\n        frequency: freq,\n        clarity: clarity || 0,\n        time,\n      });\n    }\n    pitchDisplay.current.render(false);\n  }, [clarity, freq]);\n\n  if (freq && freq > 0) {\n    requestAnimationFrame((time) => updatePitch(time));\n  }\n\n  // Keep rendering and scrolling pitchDisplay at regular time intervals\n  // even though the note has not changed\n  useAnimationFrame(updatePitch);\n\n  useEffect(() => {\n    const onResize = () => {\n      if (pitchDisplay.current) {\n        pitchDisplay.current.resize();\n      }\n    };\n    window.addEventListener('resize', onResize);\n    return () => window.removeEventListener('resize', onResize);\n  }, []);\n\n  const notes = useStoreState((state) => state.melody.notes);\n  const hasNotes = notes && notes.notes && notes.notes.length;\n  useEffect(() => {\n    if (pitchDisplay.current && notes && notes.notes) {\n      pitchDisplay.current.setMelodyNotes(notes.notes);\n    }\n  }, [notes]);\n\n  const { stopStream, setEnabled } = useStoreActions((actions) => actions);\n\n  const btnSize = 50;\n  const btnColor = BACKGROUND;\n  const btnColorPressed = '#a6a8aa';\n\n  const onDisplayRef = useCallback(\n    (element) => {\n      if (element && !pitchDisplay.current) {\n        pitchDisplay.current = new PitchDisplay(element, 6000);\n        pitchDisplay.current.setBackgroundColor(BACKGROUND);\n        if (notes) {\n          pitchDisplay.current.setMelodyNotes(notes);\n        }\n        pitchDisplay.current.playSong();\n      }\n    },\n    [notes]\n  );\n\n  useEffect(() => {\n    if (pitchDisplay.current) {\n      return pitchDisplay.current.subscribeToIntroState((val) =>\n        setInIntro(val)\n      );\n    }\n  }, []);\n\n  const onStop = async () => {\n    setEnabled(false);\n    await stopStream();\n    console.log('Stream Stopped');\n  };\n\n  const skipIntroTitle = 'Skip intro';\n  const skipIntroBody = 'Press and hold until you start singing.';\n  const skipIntroPopover = (\n    <Popover id=\"popover-skip-intro\">\n      <Popover.Title as=\"h3\">{skipIntroTitle}</Popover.Title>\n      <Popover.Content>{skipIntroBody}</Popover.Content>\n    </Popover>\n  );\n\n  return (\n    <React.Fragment>\n      <div className=\"full\" ref={onDisplayRef} />\n      <div className=\"navbar-space\" />\n      <Navbar fixed=\"bottom\" bg=\"dark\" className=\"justify-content-center unselectable\">\n        {hasNotes && (\n          <OverlayTrigger\n            show={inIntro}\n            placement=\"top\"\n            overlay={skipIntroPopover}\n          >\n            <SkipStartButton\n              onPress={() => pitchDisplay.current.seekToFirstNote()}\n              onRelease={() => pitchDisplay.current.playSong()}\n              onCancel={() => pitchDisplay.current.playSong()}\n              className=\"btn-skip-start\"\n              size={btnSize}\n              color={btnColor}\n              colorPressed={btnColorPressed}\n              inIntro={inIntro}\n            />\n          </OverlayTrigger>\n        )}\n        {hasNotes && (\n          <PauseButton\n            onPress={() => pitchDisplay.current.pauseSong()}\n            onRelease={() => pitchDisplay.current.playSong()}\n            onCancel={() => pitchDisplay.current.playSong()}\n            className=\"btn-pause\"\n            size={btnSize}\n            color={btnColor}\n            colorPressed={btnColorPressed}\n          />\n        )}\n        <StopButton\n          onRelease={onStop}\n          className=\"btn-stop\"\n          size={btnSize}\n          color={btnColor}\n          colorPressed={btnColorPressed}\n        />\n        {hasNotes && (\n          <ForwardButton\n            onPress={() => pitchDisplay.current.fastForwardSong()}\n            onRelease={() => pitchDisplay.current.playSong()}\n            className=\"btn-forward\"\n            size={btnSize}\n            color={btnColor}\n            colorPressed={btnColorPressed}\n          />\n        )}\n      </Navbar>\n    </React.Fragment>\n  );\n}\n\nexport default PitchComponent;\n","import { Connection } from 'post-me';\nimport React from 'react';\nimport { WorkerMethods } from '../../../worker/types';\n\ninterface PitchSetup {\n  analyser?: AnalyserNode;\n  audioContext?: AudioContext;\n  buffer?: Float32Array;\n}\ninterface PitchProps {\n  stream: MediaStream;\n  workerConnection: Connection<{}, WorkerMethods, {}>;\n  detectorName: 'autocorrelation' | 'mcleod';\n  windowSize: number;\n  powerThreshold: number;\n  clarityThreshold: number;\n  enabled: boolean;\n  pitchRenderer: React.ComponentType<{\n    freq: number | null;\n    clarity: number | null;\n  }>;\n}\n\n// Converts byte buffer to float buffer. Buffers must have same length.\nconst convertByteToFloatBuffer = (byteBuf, floatBuf) => {\n  for (let i = 0; i < byteBuf.length; i++) {\n    floatBuf[i] = byteBuf[i] / 128 - 1;\n  }\n};\n\n/**\n * While `enabled` is truthy, get the pitch from the input source,\n * and pass its frequency and clarity to `pitchRenderer`.\n *\n * `pitchRenderer` should be a react component that accepts `freq` and `clarity`\n * props.\n *\n * @export\n * @param {PitchProps} {\n *   stream,\n *   detectorName,\n *   workerConnection,\n *   windowSize,\n *   powerThreshold,\n *   clarityThreshold,\n *   enabled,\n *   pitchRenderer,\n * }\n * @returns\n */\nexport function PitchMonitor({\n  stream,\n  detectorName,\n  workerConnection,\n  windowSize,\n  powerThreshold,\n  clarityThreshold,\n  enabled,\n  pitchRenderer,\n}: PitchProps) {\n  const [freq, setFreq] = React.useState<number | null>(null);\n  const [clarity, setClarity] = React.useState<number | null>(null);\n  const pendingRef = React.useRef(false);\n  const pitchSetupRef = React.useRef<PitchSetup>({});\n\n  // Gets called first-thing whenever this component's props change.\n  const setupConnection = React.useCallback(async () => {\n    await workerConnection\n      .remoteHandle()\n      .call('createDetector', detectorName, windowSize, windowSize / 2);\n    const pitchSetup = pitchSetupRef.current;\n    pitchSetup.buffer = new Float32Array(windowSize);\n    // Old browsers use webkitAudioContext\n    pitchSetup.audioContext = new (window.AudioContext ||\n      window.webkitAudioContext)();\n    // Create an AudioNode from the stream.\n    const mediaStreamSource = pitchSetup.audioContext.createMediaStreamSource(\n      stream\n    );\n    // Connect it to the destination.\n    pitchSetup.analyser = pitchSetup.audioContext.createAnalyser();\n    if (pitchSetup.analyser.getFloatTimeDomainData === undefined) {\n      // byte buffer is needed for support for incomplete audio API implementation\n      pitchSetup.byteBuffer = new Uint8Array(windowSize);\n    }\n    pitchSetup.analyser.fftSize = windowSize;\n    mediaStreamSource.connect(pitchSetup.analyser);\n  }, [pitchSetupRef, windowSize, detectorName, stream, workerConnection]);\n\n  // Find the current pitch/clarity and save it in `freq`/`clarity`.\n  const updatePitch = React.useCallback(async () => {\n    if (!pendingRef.current) {\n      pendingRef.current = true;\n\n      const pitchSetup = pitchSetupRef.current;\n      const { analyser, buffer, byteBuffer, audioContext } = pitchSetup;\n      if (!analyser || !buffer || !audioContext) {\n        console.warn(\n          'Trying to update the pitch, but missing an analyser/buffer/audioContext'\n        );\n        return;\n      }\n      if (analyser.getFloatTimeDomainData !== undefined) {\n        analyser.getFloatTimeDomainData(buffer);\n      } else {\n        // Some browsers do not have AnalyserNode.getFloatTimeDomainData() yet,\n        // so use getByteTimeDomainData method instead.\n        analyser.getByteTimeDomainData(byteBuffer);\n        convertByteToFloatBuffer(byteBuffer, buffer);\n      }\n      const result = await workerConnection\n        .remoteHandle()\n        .call(\n          'getPitch',\n          buffer,\n          audioContext.sampleRate,\n          powerThreshold,\n          clarityThreshold\n        );\n      const frequency = result[0];\n      const clarity = result[1];\n      if (frequency > 0) {\n        setFreq(frequency);\n        setClarity(clarity);\n      } else {\n        setFreq(null);\n        setClarity(null);\n      }\n\n      pendingRef.current = false;\n    }\n  }, [\n    pendingRef,\n    pitchSetupRef,\n    setFreq,\n    setClarity,\n    powerThreshold,\n    clarityThreshold,\n    workerConnection,\n  ]);\n\n  // This function only gets called when the dependencies update, and it automatically\n  // cleans up when it is called subsequent times. It starts an endless loop\n  // of computing the current pitch.\n  React.useEffect(() => {\n    if (!enabled) {\n      // This function runs whenever the state of `enabled` changes.\n      // When this function is re-run, it automatically cancels the\n      // the audio monitoring, so all we need to do is return here.\n      return;\n    }\n    console.log('Starting audio monitoring.');\n    const escape = { cancelRender: false };\n    function renderFrame() {\n      if (escape.cancelRender) {\n        return;\n      }\n      requestAnimationFrame(renderFrame);\n      updatePitch();\n    }\n    (async () => {\n      await setupConnection();\n      renderFrame();\n    })();\n\n    return () => {\n      console.log('Stopping audio monitoring.');\n      escape.cancelRender = true;\n    };\n  }, [setupConnection, updatePitch, enabled]);\n\n  const PitchRenderer = pitchRenderer;\n  return <PitchRenderer freq={freq} clarity={clarity} />;\n}\n","import React, { useEffect } from 'react';\nimport qs from 'qs';\n\nimport { useStoreActions } from '../../model';\nimport { decodeS1 } from '../../services/s1Encoding';\n\nconst readMelodyNotes = () => {\n  const params = qs.parse(window.location.search.substr(1));\n  if (params.s1) {\n    try {\n      return decodeS1(params.s1);\n    } catch (error) {\n      alert(error.toString());\n    }\n  }\n};\n\nexport function AppFrame({ children }: { children: React.ReactNode }) {\n  const { setMelodyNotes } = useStoreActions((actions) => actions);\n  useEffect(() => {\n    const notes = readMelodyNotes();\n    if (notes) {\n      setMelodyNotes(notes);\n    }\n  }, [setMelodyNotes]);\n\n  return (\n    <React.Fragment>\n      <div className=\"main-container\">{children}</div>\n    </React.Fragment>\n  );\n}\n","import React from 'react';\nimport { Button, Modal } from 'react-bootstrap';\n\nexport default function ErrorModal({ error, show, onClose }) {\n  let txt = 'Oh no! Some error happened. Try using Google Chrome browser.';\n  if (error === 'mic-stream') {\n    txt = (\n      <div>\n        Oh no! This app cannot use your mic. Try to:\n        <ul>\n          <li>make sure you have the microphone connected</li>\n          <li>make sure you allowed this site to use your mic</li>\n          <li>use Google Chrome</li>\n        </ul>\n      </div>\n    );\n  } else if (error === 'audio-context') {\n    txt = (\n      <div>\n        Yikes! It seems that this app does not work on this device and/or\n        browser. Try Google Chrome.\n      </div>\n    );\n  }\n  return (\n    <Modal show={show} onHide={onClose} backdrop=\"static\" keyboard={false}>\n      <Modal.Header closeButton>\n        <Modal.Title>Error 😰</Modal.Title>\n      </Modal.Header>\n      <Modal.Body>{txt}</Modal.Body>\n      <Modal.Footer>\n        <Button variant=\"secondary\" onClick={onClose}>\n          OK\n        </Button>\n      </Modal.Footer>\n    </Modal>\n  );\n}\n","import React, { useEffect, useState } from 'react';\nimport { Button, Collapse, Navbar } from 'react-bootstrap';\nimport {\n  CaretDownFill,\n  CaretRightFill,\n  PlayCircleFill,\n} from 'react-bootstrap-icons';\nimport MetaTags from 'react-meta-tags';\nimport qs from 'qs';\n\nimport ErrorModal from '../error-modal';\nimport { useStoreActions, useStoreState } from '../../model';\n\nimport './about.css';\n\nfunction StartButton() {\n  const [active, setActive] = useState(false);\n  const { initializeStream, setEnabled } = useStoreActions(\n    (actions) => actions\n  );\n\n  // Activate the button soon after it has been mounted.\n  // This prevents a bug where stop button touch triggers this button too\n  // when they are positioned equally.\n  useEffect(() => {\n    const handle = setTimeout(() => setActive(true), 200);\n    return () => clearTimeout(handle);\n  }, []);\n\n  const start = async () => {\n    await initializeStream();\n    setEnabled(true);\n    console.log('Stream Initialized');\n  };\n\n  const text = 'START';\n\n  return (\n    <Button\n      className=\"btn-start\"\n      variant=\"primary\"\n      onClick={start}\n      disabled={!active}\n    >\n      <div className=\"btn-start-content\">\n        <div className=\"btn-start-text\">{text}</div>\n        <PlayCircleFill size={40} color=\"white\" />\n      </div>\n    </Button>\n  );\n}\n\nfunction Header() {\n  return (\n    <div className=\"heading\">\n      <h1>VOCALOUS</h1>\n      <p>Practice singing for free</p>\n    </div>\n  );\n}\n\nfunction ExternalLink({ link, target }) {\n  return (\n    <a href={link} target={target ? target : '_blank'} rel=\"noreferrer\">\n      {link}\n    </a>\n  );\n}\n\nfunction SongInfo() {\n  const params = qs.parse(window.location.search.substr(1));\n  const { lyrics, music, title } = params;\n  const notes = useStoreState((state) => state.melody.notes);\n  if (!notes) {\n    return null;\n  }\n\n  // Use MetaTags to dynamically change meta tags in <head>,\n  // they are read by crawlers and social media preview fetchers\n  const newTitle = title ? `${title} – Vocalous` : undefined;\n  return (\n    <div className=\"song-info\">\n      {newTitle && (\n        <MetaTags id={title.replace(/[\\W_]+/g, 'x')}>\n          <title>{newTitle}</title>\n          <meta property=\"og:title\" content={newTitle} />\n        </MetaTags>\n      )}\n      <div className=\"container\">\n        <h3>This link contains notes:</h3>\n        <div className=\"song-info-details\">\n          <div>\n            <strong>{title ? title : 'Untitled'}</strong>\n          </div>\n          {music && (\n            <div>\n              Music: <ExternalLink link={music} target=\"music--page\" />\n            </div>\n          )}\n          {lyrics && (\n            <div>\n              Lyrics: <ExternalLink link={lyrics} target=\"lyrics--page\" />\n            </div>\n          )}\n        </div>\n        <h5>Sing it!</h5>\n        <ol>\n          <li>Grab your headphones</li>\n          {music && <li>Start playing the music from the link</li>}\n          <li>\n            Press START from the bottom of this page and allow using your mic\n          </li>\n        </ol>\n      </div>\n    </div>\n  );\n}\n\nfunction AboutSection() {\n  const [open, setOpen] = useState(false);\n  const iconProps = {\n    size: 25,\n    color: 'black',\n  };\n  const caret = open ? (\n    <CaretDownFill {...iconProps} />\n  ) : (\n    <CaretRightFill {...iconProps} />\n  );\n  return (\n    <div className=\"container-about\">\n      <h3 onClick={() => setOpen(!open)} className=\"about-toggler\">\n        <span className=\"toggler-caret\">{caret}</span>\n        About\n      </h3>\n      <Collapse in={open}>\n        <div id=\"about-data\">\n          <h5>How does this app work?</h5>\n          <p>\n            If you opened this by a link that contains a melody, you can see the\n            information about it. By pressing start you can practice singing the\n            melody using your microphone.\n          </p>\n          <p>\n            If you can't see any song information above, you can still practice\n            singing without notes by pressing start.\n          </p>\n\n          <h5>Why doesn't this app work?</h5>\n          <p>\n            Make sure that your microphone is working and you have allowed this\n            site to use it. It's also possible that your browser does not\n            support the technology that this app uses. Try the newest Google\n            Chrome browser.\n          </p>\n\n          <h5>How does this app handle my voice?</h5>\n          <p>\n            The app respects your privacy. Your voice is not stored and is not\n            sent out from your browser. The app uses your mic only to detect the\n            pitch from your singing.\n          </p>\n          <h5>Where is the music?</h5>\n          <p>\n            This service does not contain any music for copyright reasons. Links\n            can be provided to play the music and to read the lyrics from other\n            services.\n          </p>\n          <h5>How can I create notes to a song?</h5>\n          <p>This feature will be added in the future.</p>\n          <h5>Will this app be always free?</h5>\n          <p>Yes. This is an open source project.</p>\n          <h5>Source</h5>\n          <p>\n            <a\n              href=\"https://github.com/vocalous/app\"\n              target=\"_blank\"\n              rel=\"noreferrer\"\n            >\n              https://github.com/vocalous/app\n            </a>\n          </p>\n        </div>\n      </Collapse>\n    </div>\n  );\n}\n\nexport function About() {\n  const error = useStoreState((state) => state.error);\n  const setError = useStoreActions((actions) => actions.setError);\n  return (\n    <>\n      <Header />\n      <SongInfo />\n      <AboutSection />\n      <Navbar fixed=\"bottom\" bg=\"dark\" className=\"justify-content-center \">\n        <StartButton />\n      </Navbar>\n      <ErrorModal show={!!error} onClose={() => setError(null)} error={error} />\n    </>\n  );\n}\n","import React from 'react';\n\nimport PitchComponent from './components/pitch';\nimport { PitchMonitor } from './components/pitch/pitch-monitor';\nimport { AppFrame } from './components/main/app-frame';\nimport { useStoreActions, useStoreState } from './model';\nimport { About } from './components/main/about';\n\nfunction App() {\n  const POWER_THRESHOLD = 0.15;\n\n  const detectorName = useStoreState((state) => state.detectorName);\n  const windowSize = useStoreState((state) => state.windowSize);\n  const clarityThreshold = useStoreState((state) => state.clarityThreshold);\n  const enabled = useStoreState((state) => state.enabled);\n\n  const { loaded, stream, workerConnection } = useStoreState((state) => ({\n    loaded: state.loaded,\n    loading: state.loading,\n    stream: state.stream,\n    workerConnection: state.workerConnection,\n  }));\n\n  const { checkAudioContextSupport, initializeWorker } = useStoreActions(\n    (actions) => actions\n  );\n\n  React.useEffect(() => {\n    (async () => {\n      await initializeWorker();\n      console.log('Worker initialized');\n      await checkAudioContextSupport();\n    })();\n  }, [checkAudioContextSupport, initializeWorker]);\n\n  let mainDisplay = <About />;\n  if (loaded && stream && workerConnection) {\n    const pitchRenderer = PitchComponent;\n    mainDisplay = (\n      <PitchMonitor\n        stream={stream}\n        detectorName={detectorName}\n        workerConnection={workerConnection}\n        windowSize={windowSize}\n        powerThreshold={POWER_THRESHOLD}\n        clarityThreshold={clarityThreshold}\n        enabled={enabled}\n        pitchRenderer={pitchRenderer}\n      />\n    );\n  }\n\n  return <AppFrame>{mainDisplay}</AppFrame>;\n}\n\nexport default App;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nimport 'bootstrap/dist/css/bootstrap.min.css';\nimport { StoreProvider } from 'easy-peasy';\nimport { store } from './model';\n\nReactDOM.render(\n  <React.StrictMode>\n    <StoreProvider store={store}>\n      <App />\n    </StoreProvider>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n","// Encoder and decoder for melody notes so that they can be added to URL.\n// Binary data is base64 encoded with some characters replaced so that\n// it is safe to be used in URL. Encoding uses lossy compression, original\n// data loses some timing accuracy.\n//\n// Binary starts with 16-bit checksum.\n//\n// Notes follow either in 16-bit or 24-bit format.\n// 16-bit:\n// FXXXXXYYYYZZZZZZ\n// 24-bit:\n// FXXXXXXXXXXXYYYYYYZZZZZZ\n//\n// F: 0=16-bit note, 1=24-bit note\n// X: silence before this note, relative to the end of previous note (0.1 ms)\n// Y: duration (0.1 ms)\n// Z: pitch\n\n// To save space, use larger precision.\nconst PRECISION = 100; // in milliseconds\n\nconst SHORT_BITS = {\n  start: 5,\n  duration: 4,\n  pitch: 6,\n};\n\nconst LONG_BITS = {\n  start: 11,\n  duration: 6,\n  pitch: 6,\n};\n\n// Returns true if this note can be encoded with 16 bits.\nfunction canUseShort(start, duration) {\n  return start < 1 << SHORT_BITS.start && duration < 1 << SHORT_BITS.duration;\n}\n\n// Replaces some characters in base64 encoded data to be URL safe (RFC 3986):\n// '+' -> '_'\n// '/' -> '.'\n// '=' -> '-'\nfunction safeBase64(data) {\n  return data.replace(/\\+/g, '_').replace(/\\//g, '.').replace(/=/g, '-');\n}\n\nfunction unsafeBase64(data) {\n  return data.replace(/_/g, '+').replace(/\\./g, '/').replace(/-/g, '=');\n}\n\nexport function decodeS1(data) {\n  const notes = [];\n  const base64 = unsafeBase64(data);\n  const buffer = Buffer.from(base64, 'base64');\n\n  if (buffer.length < 2) {\n    throw new Error('No content');\n  }\n\n  let pos = 0;\n  let checksum = 0;\n  // read original 16-bit checksum\n  const origChecksum = buffer.readUInt16BE(pos);\n  pos += 2;\n\n  // read 16-bit timestamp\n  const days = buffer.readUInt16BE(pos);\n  pos += 2;\n  checksum += days;\n  const created = new Date(days * 86400000);\n\n  // read content\n  let lastEnd = 0;\n  while (pos < buffer.length) {\n    // check first bit\n    const isLong = buffer.readUIntBE(pos, 1) & 128;\n    let bytes;\n    let start;\n    let duration;\n    let pitch;\n    if (isLong) {\n      // read 24-bit value\n      bytes = 3;\n      const value = buffer.readUIntBE(pos, bytes);\n      start =\n        (value >> (LONG_BITS.duration + LONG_BITS.pitch)) &\n        ((1 << LONG_BITS.start) - 1);\n      duration = (value >> LONG_BITS.pitch) & ((1 << LONG_BITS.duration) - 1);\n      pitch =\n        value & ((1 << LONG_BITS.pitch) - 1) & ((1 << LONG_BITS.pitch) - 1);\n      checksum += value;\n    } else {\n      // read 16-bit value\n      bytes = 2;\n      const value = buffer.readUIntBE(pos, bytes);\n      start =\n        (value >> (SHORT_BITS.duration + SHORT_BITS.pitch)) &\n        ((1 << SHORT_BITS.start) - 1);\n      duration = (value >> SHORT_BITS.pitch) & ((1 << SHORT_BITS.duration) - 1);\n      pitch =\n        value & ((1 << SHORT_BITS.pitch) - 1) & ((1 << SHORT_BITS.pitch) - 1);\n      checksum += value;\n    }\n\n    const note = {\n      start: lastEnd + start * PRECISION,\n      duration: duration * PRECISION,\n      pitch,\n    };\n    notes.push(note);\n    lastEnd = note.start + note.duration;\n    pos += bytes;\n  }\n\n  // 16-bit checksum\n  if ((checksum & 65535) !== origChecksum) {\n    throw new Error('Corrupted data: invalid checksum');\n  }\n\n  return {\n    created,\n    notes,\n  };\n}\n\nexport function encodeS1(data) {\n  const buffers = [];\n  let lastPos = 0;\n  let checksum = 0;\n\n  function bitHandle(value, valueBits, shiftBits) {\n    const max = (1 << valueBits) - 1;\n    if (value > max) {\n      throw new Error(\n        `${valueBits} bits not enough for value ${value}, use another encoding`\n      );\n    }\n    return value << shiftBits;\n  }\n\n  function addTimestamp() {\n    // add timestamp, days since epoch\n    const days = Math.floor(new Date().getTime() / 86400000);\n    const bytes = Buffer.alloc(2);\n    bytes.writeUInt16BE(days);\n    buffers.push(bytes);\n    checksum += days;\n  }\n\n  addTimestamp();\n\n  for (let i = 0; i < data.notes.length; i++) {\n    const note = data.notes[i];\n    const start = Math.floor((note.start - lastPos * PRECISION) / PRECISION);\n    const duration = Math.floor(note.duration / PRECISION);\n    lastPos += start + duration;\n    const pitch = note.pitch;\n\n    if (canUseShort(start, duration)) {\n      // we can write a note with 16 bits\n      let num = bitHandle(\n        start,\n        SHORT_BITS.start,\n        SHORT_BITS.duration + SHORT_BITS.pitch\n      );\n      num += bitHandle(duration, SHORT_BITS.duration, SHORT_BITS.pitch);\n      num += bitHandle(pitch, SHORT_BITS.pitch, 0);\n      const bytes = Buffer.alloc(2);\n      bytes.writeUInt16BE(num);\n      buffers.push(bytes);\n      checksum += num;\n    } else {\n      // write a note with 24 bits\n      let num = 1 << 23; // first bit indicates 24-bit note\n      num += bitHandle(\n        start,\n        LONG_BITS.start,\n        LONG_BITS.duration + LONG_BITS.pitch\n      );\n      num += bitHandle(duration, LONG_BITS.duration, LONG_BITS.pitch);\n      num += bitHandle(pitch, LONG_BITS.pitch, 0);\n      const bytes = Buffer.alloc(3);\n      bytes.writeUIntBE(num, 0, 3);\n      buffers.push(bytes);\n      checksum += num;\n    }\n  }\n\n  // add 16-bit checksum to the beginning of buffer\n  const checksumBuf = Buffer.alloc(2);\n  checksumBuf.writeUInt16BE(checksum & 65535);\n  buffers.unshift(checksumBuf);\n\n  const output = Buffer.concat(buffers).toString('base64');\n  return safeBase64(output);\n}\n"],"sourceRoot":""}